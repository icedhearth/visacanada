<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formul√°rio IMM 5257 (COMPLETO) | Visto Canadense</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* O mesmo CSS da vers√£o anterior, sem altera√ß√µes */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 15px; color: #333; }
        .container { max-width: 850px; margin: 20px auto; background-color: #ffffff; padding: 30px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #1d3557; margin-bottom: 25px; }
        .form-section { display: none; }
        .form-section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bar { width: 100%; background-color: #e9ecef; border-radius: 5px; margin-bottom: 30px; overflow: hidden; }
        .progress-bar-fill { height: 12px; width: 0%; background-color: #e63946; border-radius: 5px; transition: width 0.4s ease-in-out; }
        .form-group { margin-bottom: 22px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        input[type="text"], input[type="date"], input[type="email"], input[type="tel"], select, textarea { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 5px; box-sizing: border-box; font-size: 16px; transition: border-color 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: #e63946; outline: none; box-shadow: 0 0 5px rgba(230, 57, 70, 0.2); }
        fieldset { border: 1px solid #dee2e6; border-radius: 5px; padding: 20px; margin-bottom: 20px; }
        legend { font-weight: 700; color: #1d3557; padding: 0 10px; }
        .radio-group label { display: inline-block; margin-right: 25px; font-weight: normal; }
        .hidden-field { display: none; margin-top: 15px; border-left: 3px solid #e63946; padding-left: 15px; animation: fadeIn 0.5s; }
        .navigation-buttons { display: flex; justify-content: space-between; margin-top: 30px; }
        button { padding: 12px 28px; border: none; border-radius: 5px; background-color: #e63946; color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        button:hover:not(:disabled) { background-color: #d62828; transform: translateY(-2px); }
        button:disabled { background-color: #adb5bd; cursor: not-allowed; }
        button#prevBtn { background-color: #6c757d; }
        button#prevBtn:hover { background-color: #5a6268; }
        .declaration-box { border: 1px solid #ddd; padding: 15px; margin-top: 20px; background-color: #fafafa; font-size: 14px; max-height: 250px; overflow-y: auto; }
        .agreement-group { margin-top: 20px; display: flex; align-items: center; }
        .agreement-group input[type="checkbox"] { width: auto; margin-right: 10px; transform: scale(1.2); }
    </style>
</head>
<body>

<div class="container">
    <h1>Formul√°rio de Visto Canadense (IMM 5257)</h1>
    <div class="progress-bar"><div class="progress-bar-fill" id="progressBar"></div></div>

    <form id="imm5257Form">
        <div class="form-section active">
            <h2>Dados Pessoais</h2>
            <div class="form-group"><label for="fullName">Nome Completo (igual ao passaporte)</label><input type="text" id="fullName" name="fullName" required></div>
            <div class="form-group"><label>J√° usou outro nome (apelido, nome de solteira, etc.)?</label>
                <div class="radio-group"><label><input type="radio" name="usedOtherName" value="Sim"> Sim</label><label><input type="radio" name="usedOtherName" value="N√£o" checked> N√£o</label></div>
                <div id="otherNameField" class="hidden-field"><label for="otherName">Nome Adicional</label><input type="text" id="otherName" name="otherName"></div>
            </div>
            <div class="form-group"><label for="sex">Sexo</label><select id="sex" name="sex"><option value="Feminino">Feminino</option><option value="Masculino">Masculino</option><option value="Outro">Outro</option></select></div>
            <div class="form-group"><label for="dob">Data de Nascimento</label><input type="date" id="dob" name="dob" required></div>
            <div class="form-group"><label for="pob">Local de Nascimento (Cidade e Pa√≠s)</label><input type="text" id="pob" name="pob" required></div>
            <div class="form-group"><label for="citizenship">Cidadania</label><input type="text" id="citizenship" name="citizenship" required></div>
        </div>

        <div class="form-section">
            <h2>Resid√™ncia</h2>
            <fieldset>
                <legend>Resid√™ncia Atual</legend>
                <div class="form-group"><label for="currentResidenceCountry">Pa√≠s/Territ√≥rio</label><input type="text" id="currentResidenceCountry" name="currentResidenceCountry" required></div>
                <div class="form-group"><label for="currentResidenceStatus">Status</label><select id="currentResidenceStatus" name="currentResidenceStatus"><option>Cidad√£o</option><option>Residente Permanente</option><option>Trabalhador</option><option>Estudante</option><option>Visitante</option><option>Outro</option></select></div>
            </fieldset>
            <div class="form-group"><label>Viveu em outro pa√≠s por mais de 6 meses nos √∫ltimos 5 anos?</label>
                <div class="radio-group"><label><input type="radio" name="livedOtherCountry" value="Sim"> Sim</label><label><input type="radio" name="livedOtherCountry" value="N√£o" checked> N√£o</label></div>
                <div id="previousResidenceField" class="hidden-field"><label for="previousResidenceDetails">Detalhes dos pa√≠ses anteriores</label><textarea name="previousResidenceDetails" placeholder="Liste cada pa√≠s, status e per√≠odo."></textarea></div>
            </div>
        </div>

        <div class="form-section">
            <h2>Estado Civil e Idioma</h2>
            <div class="form-group"><label for="maritalStatus">Estado Civil Atual</label>
                <select id="maritalStatus" name="maritalStatus">
                    <option value="Solteiro(a)">Solteiro(a)</option><option value="Casado(a)">Casado(a)</option><option value="Uni√£o Est√°vel">Uni√£o Est√°vel</option><option value="Divorciado(a)">Divorciado(a)</option><option value="Vi√∫vo(a)">Vi√∫vo(a)</option>
                </select>
            </div>
            <div id="spouseDetails" class="hidden-field"><fieldset><legend id="spouseLegend">Dados do C√¥njuge</legend>
                    <div class="form-group"><label for="spouseFullName">Nome Completo</label><input type="text" id="spouseFullName" name="spouseFullName"></div>
                    <div id="relationshipDates"><div class="form-group"><label for="marriageDate">Data de In√≠cio do Casamento/Uni√£o</label><input type="date" id="marriageDate" name="marriageDate"></div></div>
            </fieldset></div>
            <div class="form-group"><label for="nativeLanguage">L√≠ngua Nativa</label><input type="text" id="nativeLanguage" name="nativeLanguage"></div>
            <div class="form-group"><label for="correspondenceLanguage">Idioma para correspond√™ncia</label><select id="correspondenceLanguage" name="correspondenceLanguage"><option>Ingl√™s</option><option>Franc√™s</option></select></div>
        </div>

        <div class="form-section">
            <h2>Passaporte e Documentos</h2>
            <fieldset><legend>Passaporte</legend>
                <div class="form-group"><label for="passportNumber">N√∫mero do Passaporte</label><input type="text" id="passportNumber" name="passportNumber" required></div>
                <div class="form-group"><label for="passportCountry">Pa√≠s de Emiss√£o</label><input type="text" id="passportCountry" name="passportCountry" required></div>
                <div class="form-group"><label for="passportIssueDate">Data de Emiss√£o</label><input type="date" id="passportIssueDate" name="passportIssueDate" required></div>
                <div class="form-group"><label for="passportExpiryDate">Data de Validade</label><input type="date" id="passportExpiryDate" name="passportExpiryDate" required></div>
            </fieldset>
             <div class="form-group"><label>Possui Documento de Identidade Nacional?</label>
                <div class="radio-group"><label><input type="radio" name="hasNationalId" value="Sim"> Sim</label><label><input type="radio" name="hasNationalId" value="N√£o" checked> N√£o</label></div>
                <div id="nationalIdField" class="hidden-field"><label for="nationalIdNumber">N√∫mero do Documento</label><input type="text" id="nationalIdNumber" name="nationalIdNumber"></div>
            </div>
        </div>
        
        <div class="form-section">
            <h2>Informa√ß√µes de Contato</h2>
            <div class="form-group"><label for="mailingAddress">Endere√ßo de Correspond√™ncia</label><textarea id="mailingAddress" name="mailingAddress" required placeholder="Endere√ßo completo com rua, n√∫mero, bairro, CEP, cidade e pa√≠s."></textarea></div>
            <div class="form-group"><label for="phone">Telefone Celular</label><input type="tel" id="phone" name="phone" required></div>
            <div class="form-group"><label for="email">E-mail</label><input type="email" id="email" name="email" required></div>
        </div>

        <div class="form-section">
            <h2>Detalhes da Visita ao Canad√°</h2>
            <div class="form-group"><label for="purpose">Prop√≥sito da Visita</label><select id="purpose" name="purpose"><option>Turismo</option><option>Neg√≥cios</option><option>Visitar Fam√≠lia/Amigos</option></select></div>
            <div class="form-group"><label for="stay_from">Data de Chegada</label><input type="date" id="stay_from" name="stay_from" required></div>
            <div class="form-group"><label for="stay_to">Data de Sa√≠da</label><input type="date" id="stay_to" name="stay_to" required></div>
            <div class="form-group"><label for="funds">Fundos dispon√≠veis para a estadia (CAD)</label><input type="text" id="funds" name="funds" placeholder="Ex: 5000" required></div>
            <div class="form-group"><label for="visit_person_details">Pessoas ou institui√ß√µes que ir√° visitar (Nome, endere√ßo, rela√ß√£o)</label><textarea id="visit_person_details" name="visit_person_details"></textarea></div>
        </div>
        
        <div class="form-section">
            <h2>Educa√ß√£o e Emprego</h2>
            <div class="form-group"><label>Possui ensino superior ou t√©cnico?</label>
                <div class="radio-group"><label><input type="radio" name="hasEducation" value="Sim"> Sim</label><label><input type="radio" name="hasEducation" value="N√£o" checked> N√£o</label></div>
                <div id="educationField" class="hidden-field"><label for="educationDetails">Detalhes da Educa√ß√£o</label><textarea name="educationDetails" placeholder="Liste curso, escola, cidade, per√≠odo."></textarea></div>
            </div>
            <div class="form-group"><label for="employmentDetails">Hist√≥rico de Emprego (√∫ltimos 10 anos)</label><textarea id="employmentDetails" name="employmentDetails" placeholder="Liste cada emprego (per√≠odo, cargo, empregador, cidade), come√ßando pelo mais recente." required></textarea></div>
        </div>

        <div class="form-section">
            <h2>Informa√ß√µes de Hist√≥rico</h2>
            <p>Responda "Sim" ou "N√£o" para as perguntas abaixo. Se responder "Sim", forne√ßa detalhes.</p>
            <div class="form-group"><label>1. Voc√™ ou um familiar teve tuberculose nos √∫ltimos 2 anos?</label>
                <div class="radio-group"><label><input type="radio" name="bg_q1" value="Sim"> Sim</label><label><input type="radio" name="bg_q1" value="N√£o" checked> N√£o</label></div>
                <textarea name="bg_q1_details" class="hidden-field" placeholder="Forne√ßa detalhes."></textarea>
            </div>
             <div class="form-group"><label>2. J√° teve um visto ou entrada recusada para o Canad√° ou outro pa√≠s?</label>
                <div class="radio-group"><label><input type="radio" name="bg_q2" value="Sim"> Sim</label><label><input type="radio" name="bg_q2" value="N√£o" checked> N√£o</label></div>
                <textarea name="bg_q2_details" class="hidden-field" placeholder="Qual pa√≠s, quando e o motivo."></textarea>
            </div>
            <div class="form-group"><label>3. J√° cometeu, foi preso(a), acusado(a) ou condenado(a) por crime em qualquer pa√≠s?</label>
                 <div class="radio-group"><label><input type="radio" name="bg_q3" value="Sim"> Sim</label><label><input type="radio" name="bg_q3" value="N√£o" checked> N√£o</label></div>
                <textarea name="bg_q3_details" class="hidden-field" placeholder="Forne√ßa detalhes completos."></textarea>
            </div>
            <div class="form-group"><label>4. Serviu em alguma organiza√ß√£o militar, mil√≠cia ou pol√≠cia?</label>
                 <div class="radio-group"><label><input type="radio" name="bg_q4" value="Sim"> Sim</label><label><input type="radio" name="bg_q4" value="N√£o" checked> N√£o</label></div>
                <textarea name="bg_q4_details" class="hidden-field" placeholder="Quais datas, pa√≠s e detalhes da sua fun√ß√£o."></textarea>
            </div>
        </div>

        <div class="form-section">
            <h2>Declara√ß√£o e Assinatura</h2>
            <div class="declaration-box">
                <h4>Declara√ß√£o e Autoriza√ß√£o</h4>
                <p>Eu, <strong id="declarantName"></strong>, declaro que li e compreendi as quest√µes e que minhas respostas s√£o verdadeiras e completas. Estou ciente de que fornecer informa√ß√µes falsas √© uma ofensa grave sob a lei de imigra√ß√£o do Canad√°.</p>
                <p>Autorizo a empresa <strong>Objetivo Turismo Ltda.</strong> a proceder com o envio do Formul√°rio IMM 5257 e realizar pagamentos e agendamentos em meu nome.</p>
            </div>
            <div class="form-group"><label for="signature_location">Local</label><input type="text" id="signature_location" name="signature_location" required></div>
            <div class="agreement-group"><input type="checkbox" id="agreeTerms"><label for="agreeTerms">Li e concordo com os termos.</label></div>
        </div>

        <div class="navigation-buttons">
            <button type="button" id="prevBtn" onclick="navigate(-1)">Anterior</button>
            <button type="button" id="nextBtn" onclick="navigate(1)">Pr√≥ximo</button>
            <button type="button" id="submitBtn" onclick="generateAndSend()">Gerar PDF e Enviar para An√°lise</button>
        </div>
    </form>
</div>


<script type="module">
    // --- IN√çCIO DA SE√á√ÉO DE SCRIPTS ATUALIZADA ---

    // 1. Importa√ß√µes do Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-storage.js";

    // 2. Suas credenciais do Firebase (extra√≠das do arquivo que voc√™ forneceu)
const firebaseConfig = {
    apiKey: "AIzaSyAkBV0rHEghBOHl2mDOs6rMDHkUgYMxFr0",
    authDomain: "visaformulariostorage.firebaseapp.com",
    projectId: "visaformulariostorage",
    // üëá ESTA √â A LINHA CORRETA
    storageBucket: "visaformulariostorage.firebasestorage.app", 
    messagingSenderId: "720170394408",
    appId: "1:720170394408:web:b1c294c39c489388f6261d",
    measurementId: "G-ZFCV4JEEFT"
};

    // 3. Inicializa√ß√£o do Firebase
    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const { jsPDF } = window.jspdf;

    let currentSection = 0;
    const sections = document.querySelectorAll('.form-section');
    const progressBar = document.getElementById('progressBar');
    const submitBtn = document.getElementById('submitBtn');
    const agreeCheckbox = document.getElementById('agreeTerms');
    
    // Anexando as fun√ß√µes principais ao objeto window para que o onclick as encontre
    window.navigate = function(step) {
        if (step === 1 && !validateForm()) return;
        currentSection = Math.max(0, Math.min(sections.length - 1, currentSection + step));
        showSection(currentSection);
    }

    window.generateAndSend = async function() {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processando...';
        
        try {
            alert('Gerando o PDF...');
            const doc = new jsPDF({ lineHeight: 1.5 });
            const data = Object.fromEntries(new FormData(document.getElementById('imm5257Form')).entries());
            
            // L√≥gica COMPLETA para popular o PDF
            populatePdf(doc, data);

            const pdfBlob = doc.output('blob');
            const solicitanteNome = data.fullName || 'Nao_Informado';
            const timestamp = Date.now();
            const firebaseFileName = `formularios_canada/IMM5257_${solicitanteNome.replace(/\s+/g, '_')}_${timestamp}.pdf`;

            alert('Enviando para o servidor seguro...');
            const storageRef = ref(storage, firebaseFileName);
            await uploadBytes(storageRef, pdfBlob);

            const downloadUrl = await getDownloadURL(storageRef);
            
            alert('Sucesso! Preparando para enviar via WhatsApp.');
            const whatsappMessage = `An√°lise de Visto Canadense para ${solicitanteNome} est√° pronta.\n\nAcesse o formul√°rio seguro no link: ${downloadUrl}`;
            
            const fixedWhatsAppNumber = '5561999998165';
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${fixedWhatsAppNumber}&text=${encodeURIComponent(whatsappMessage)}`;
            
            window.open(whatsappUrl, '_blank');

        } catch (error) {
            console.error("Erro no processo de envio:", error);
            alert("Ocorreu um erro ao enviar o formul√°rio. Verifique o console para mais detalhes.");
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Gerar PDF e Enviar para An√°lise';
        }
    }
    
    // --- FUN√á√ïES AUXILIARES ---
    function populatePdf(doc, data) {
        let y = 22;
        const addTitle = (title) => {
            if (y > 260) { doc.addPage(); y = 20; }
            doc.setFontSize(14).setFont(undefined, 'bold');
            doc.text(title, 14, y);
            y += 10;
        };
        const addField = (label, value) => {
            if (value && value.trim() !== '') {
                if (y > 270) { doc.addPage(); y = 20; }
                doc.setFontSize(10).setFont(undefined, 'bold'); doc.text(label, 14, y);
                doc.setFontSize(10).setFont(undefined, 'normal');
                const textLines = doc.splitTextToSize(value, 170); doc.text(textLines, 50, y);
                y += (textLines.length * 5) + 4;
            }
        };

        addTitle("Respostas - Formul√°rio IMM 5257");
        
        addTitle("Dados Pessoais");
        addField("Nome Completo:", data.fullName);
        addField("Outro Nome Usado:", data.otherName);
        addField("Sexo:", data.sex);
        addField("Data de Nasc.:", data.dob);
        addField("Local de Nasc.:", data.pob);
        addField("Cidadania:", data.citizenship);
        
        addTitle("Resid√™ncia e Estado Civil");
        addField("Pa√≠s de Resid√™ncia:", data.currentResidenceCountry);
        addField("Status:", data.currentResidenceStatus);
        addField("Resid. Anteriores:", data.previousResidenceDetails);
        addField("Estado Civil:", data.maritalStatus);
        addField("Nome C√¥njuge:", data.spouseFullName);
        addField("Data Casamento/Uni√£o:", data.marriageDate);
        addField("L√≠ngua Nativa:", data.nativeLanguage);
        addField("Idioma Correspond√™ncia:", data.correspondenceLanguage);
        
        addTitle("Passaporte e Documentos");
        addField("No. Passaporte:", data.passportNumber);
        addField("Pa√≠s Emiss√£o:", data.passportCountry);
        addField("Datas (Emiss√£o/Val.):", `${data.passportIssueDate || ''} / ${data.passportExpiryDate || ''}`);
        addField("ID Nacional:", data.nationalIdNumber);

        addTitle("Contato e Visita");
        addField("E-mail:", data.email);
        addField("Telefone:", data.phone);
        addField("Endere√ßo:", data.mailingAddress);
        addField("Prop√≥sito da Visita:", data.purpose);
        addField("Per√≠odo:", `${data.stay_from || ''} a ${data.stay_to || ''}`);
        addField("Fundos (CAD):", data.funds);
        addField("Pessoas/Locais a Visitar:", data.visit_person_details);

        addTitle("Educa√ß√£o e Emprego");
        addField("Educa√ß√£o:", data.educationDetails);
        addField("Emprego (10 anos):", data.employmentDetails);

        addTitle("Hist√≥rico");
        addField("Tuberculose:", `${data.bg_q1} ${data.bg_q1_details ? '- Detalhes: ' + data.bg_q1_details : ''}`);
        addField("Visto Recusado:", `${data.bg_q2} ${data.bg_q2_details ? '- Detalhes: ' + data.bg_q2_details : ''}`);
        addField("Crimes:", `${data.bg_q3} ${data.bg_q3_details ? '- Detalhes: ' + data.bg_q3_details : ''}`);
        addField("Servi√ßo Militar:", `${data.bg_q4} ${data.bg_q4_details ? '- Detalhes: ' + data.bg_q4_details : ''}`);
        
        addTitle("Declara√ß√£o");
        addField("Local:", data.signature_location);
        addField("Data:", new Date().toLocaleDateString('pt-BR'));
        addField("Termos:", data.agreeTerms ? "Concordou com os termos" : "N√£o concordou");
    }

    function showSection(sectionIndex) {
        if (sectionIndex === sections.length - 1) { document.getElementById('declarantName').textContent = document.getElementById('fullName').value || "[Nome n√£o informado]"; }
        sections.forEach((section, index) => section.classList.toggle('active', index === sectionIndex));
        updateProgressBar();
        updateButtons();
    }
    function validateForm() {
        const activeSection = sections[currentSection];
        for (const input of activeSection.querySelectorAll('[required]')) {
            if (!input.value) { alert('Por favor, preencha todos os campos obrigat√≥rios.'); input.focus(); return false; }
        }
        return true;
    }
    function updateProgressBar() { progressBar.style.width = ((currentSection) / (sections.length - 1)) * 100 + '%'; }
    function updateButtons() {
        document.getElementById('prevBtn').style.display = currentSection === 0 ? 'none' : 'inline-block';
        document.getElementById('nextBtn').style.display = currentSection === sections.length - 1 ? 'none' : 'inline-block';
        submitBtn.style.display = currentSection === sections.length - 1 ? 'inline-block' : 'none';
        if (currentSection === sections.length - 1) { submitBtn.disabled = !agreeCheckbox.checked; }
    }
    
    function setupConditionalLogic(radioGroupName, fieldId) {
        document.querySelectorAll(`input[type="radio"][name="${radioGroupName}"]`).forEach(radio => {
            radio.addEventListener('change', e => {
                const field = document.getElementById(fieldId);
                const isYes = e.target.value === 'Sim';
                field.style.display = isYes ? 'block' : 'none';
                field.querySelectorAll('input, textarea').forEach(input => input.required = isYes);
            });
        });
    }

    // Inicia a l√≥gica condicional e o formul√°rio
    setupConditionalLogic('usedOtherName', 'otherNameField');
    setupConditionalLogic('livedOtherCountry', 'previousResidenceField');
    setupConditionalLogic('hasNationalId', 'nationalIdField');
    setupConditionalLogic('hasEducation', 'educationField');
    setupConditionalLogic('bg_q1', 'bg_q1_details'); setupConditionalLogic('bg_q2', 'bg_q2_details'); setupConditionalLogic('bg_q3', 'bg_q3_details'); setupConditionalLogic('bg_q4', 'bg_q4_details');
    document.getElementById('maritalStatus').addEventListener('change', e => {
        const value = e.target.value; const field = document.getElementById('spouseDetails');
        const isNeeded = ['Casado(a)', 'Uni√£o Est√°vel', 'Divorciado(a)', 'Vi√∫vo(a)'].includes(value);
        field.style.display = isNeeded ? 'block' : 'none';
        field.querySelectorAll('input').forEach(input => input.required = isNeeded);
    });
    agreeCheckbox.addEventListener('change', updateButtons);
    
    // Inicia o formul√°rio na primeira se√ß√£o
    showSection(currentSection);

</script>

</body>
</html>
