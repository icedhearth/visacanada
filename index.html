<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário IMM 5257 v3 | Visto Canadense</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 15px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background-color: #ffffff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #2c3e50; margin-bottom: 20px;}
        .form-section { display: none; }
        .form-section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .progress-bar { width: 100%; background-color: #e0e0e0; border-radius: 5px; margin-bottom: 25px; }
        .progress-bar-fill { height: 10px; width: 0%; background-color: #d9534f; border-radius: 5px; transition: width 0.4s ease-in-out; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input[type="text"], input[type="date"], input[type="email"], input[type="tel"], select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        fieldset { border: 1px solid #ccc; border-radius: 4px; padding: 15px; margin-bottom: 20px; }
        legend { font-weight: 600; color: #3498db; }
        .radio-group label { display: inline-block; margin-right: 20px; font-weight: normal;}
        .hidden-field { display: none; margin-top: 15px; }
        .navigation-buttons { display: flex; justify-content: space-between; margin-top: 30px; }
        button { padding: 12px 25px; border: none; border-radius: 5px; background-color: #d9534f; color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        button:hover:not(:disabled) { background-color: #c9302c; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button#prevBtn { background-color: #95a5a6; }
        button#prevBtn:hover { background-color: #7f8c8d; }
        .declaration-box { border: 1px solid #ddd; padding: 15px; margin-top: 20px; background-color: #fafafa; font-size: 14px; max-height: 250px; overflow-y: auto; }
        .agreement-group { margin-top: 20px; display: flex; align-items: center; }
        .agreement-group input[type="checkbox"] { width: auto; margin-right: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Formulário IMM 5257</h1>
    <div class="progress-bar"><div class="progress-bar-fill" id="progressBar"></div></div>

    <form id="imm5257Form">
        <div class="form-section active">
            <h2>Seção 1: Dados Pessoais</h2>
            <div class="form-group"><label for="fullName">Nome Completo (como no passaporte)</label><input type="text" id="fullName" name="fullName" placeholder="SOBRENOME, Nome" required></div>
            <div class="form-group"><label for="maritalStatus">Estado Civil Atual</label>
                <select id="maritalStatus" name="maritalStatus">
                    <option value="Solteiro(a)">Solteiro(a)</option>
                    <option value="Casado(a)">Casado(a)</option>
                    <option value="União Estável">União Estável</option>
                    <option value="Divorciado(a)">Divorciado(a)</option>
                    <option value="Viúvo(a)">Viúvo(a)</option>
                </select>
            </div>
            <div id="spouseDetails" class="hidden-field">
                <fieldset>
                    <legend id="spouseLegend">Dados do Cônjuge / Companheiro(a)</legend>
                    <div class="form-group"><label for="spouseFullName">Nome Completo do Cônjuge/Companheiro(a)</label><input type="text" id="spouseFullName" name="spouseFullName"></div>
                    <div class="form-group"><label for="spouseDob">Data de Nascimento</label><input type="date" id="spouseDob" name="spouseDob"></div>
                    <div id="relationshipDates" class="hidden-field">
                         <div class="form-group"><label for="marriageDate">Data de Início do Casamento/União</label><input type="date" id="marriageDate" name="marriageDate"></div>
                         <div class="form-group"><label for="separationDate">Data de Fim do Relacionamento</label><input type="date" id="separationDate" name="separationDate"></div>
                    </div>
                </fieldset>
            </div>
        </div>

        <div class="form-section">
            <h2>Seção 2: Informações de Histórico</h2>
            <p>Responda "Sim" ou "Não" para as perguntas abaixo. Se responder "Sim", forneça detalhes.</p>
            
            <div class="form-group">
                <label>1. Você ou algum familiar próximo já teve tuberculose?</label>
                <div class="radio-group">
                    <label><input type="radio" name="bg_q1" value="Sim"> Sim</label>
                    <label><input type="radio" name="bg_q1" value="Não" checked> Não</label>
                </div>
                <textarea name="bg_q1_details" class="hidden-field" placeholder="Forneça detalhes sobre o diagnóstico e tratamento."></textarea>
            </div>
            <div class="form-group">
                <label>2. Você já teve um visto ou entrada recusada para o Canadá ou qualquer outro país?</label>
                <div class="radio-group">
                    <label><input type="radio" name="bg_q2" value="Sim"> Sim</label>
                    <label><input type="radio" name="bg_q2" value="Não" checked> Não</label>
                </div>
                <textarea name="bg_q2_details" class="hidden-field" placeholder="Forneça detalhes: qual país, quando e o motivo da recusa."></textarea>
            </div>
            <div class="form-group">
                <label>3. Você já cometeu, foi preso(a), acusado(a) ou condenado(a) por qualquer crime em qualquer país?</label>
                 <div class="radio-group">
                    <label><input type="radio" name="bg_q3" value="Sim"> Sim</label>
                    <label><input type="radio" name="bg_q3" value="Não" checked> Não</label>
                </div>
                <textarea name="bg_q3_details" class="hidden-field" placeholder="Forneça detalhes completos sobre o ocorrido."></textarea>
            </div>
        </div>

        <div class="form-section">
            <h2>Seção 3: Declaração e Assinatura</h2>
            <div class="declaration-box">
                <h4>Declaração e Autorização</h4>
                <p>Eu, <strong id="declarantName"></strong>, declaro, sob as penas da lei, que li e compreendi integralmente todas as questões contidas nesta solicitação de visto (Formulário IMM 5257) e afirmo que as respostas por mim fornecidas são verdadeiras, completas e corretas, conforme o meu melhor conhecimento e convicção.</p>
                <p>Declaro estar ciente de que qualquer declaração falsa, incompleta ou enganosa poderá resultar na recusa do visto ou na negativa de admissão no Canadá.</p>
                <p>Autorizo expressamente a empresa <strong>Objetivo Turismo Ltda.</strong>, a proceder com o envio eletrônico do Formulário IMM 5257 às autoridades canadenses, bem como a realizar o pagamento das taxas e os agendamentos necessários.</p>
            </div>
            <div class="form-group">
                <label for="signature_location">Local da Assinatura</label>
                <input type="text" id="signature_location" name="signature_location" required>
            </div>
            <div class="agreement-group">
                <input type="checkbox" id="agreeTerms">
                <label for="agreeTerms">Li e concordo com os termos desta declaração.</label>
            </div>
        </div>

        <div class="navigation-buttons">
            <button type="button" id="prevBtn" onclick="navigate(-1)">Anterior</button>
            <button type="button" id="nextBtn" onclick="navigate(1)">Próximo</button>
            <button type="button" id="submitBtn" onclick="generateAndSend()">Gerar PDF e Enviar</button>
        </div>
    </form>
</div>

<script>
    let currentSection = 0;
    const sections = document.querySelectorAll('.form-section');
    const progressBar = document.getElementById('progressBar');
    const submitBtn = document.getElementById('submitBtn');
    const agreeCheckbox = document.getElementById('agreeTerms');
    const maritalStatusSelect = document.getElementById('maritalStatus');

    function showSection(sectionIndex) {
        if (sectionIndex === sections.length - 1) {
            document.getElementById('declarantName').textContent = document.getElementById('fullName').value || "[Nome não informado]";
        }
        sections.forEach((section, index) => {
            section.classList.toggle('active', index === sectionIndex);
        });
        updateProgressBar();
        updateButtons();
    }

    function navigate(step) {
        if (step === 1 && !validateForm()) return false;
        currentSection = Math.max(0, Math.min(sections.length - 1, currentSection + step));
        showSection(currentSection);
    }

    function updateProgressBar() {
        const progress = ((currentSection) / (sections.length - 1)) * 100;
        progressBar.style.width = progress + '%';
    }

    function updateButtons() {
        document.getElementById('prevBtn').style.display = currentSection === 0 ? 'none' : 'inline-block';
        document.getElementById('nextBtn').style.display = currentSection === sections.length - 1 ? 'none' : 'inline-block';
        submitBtn.style.display = currentSection === sections.length - 1 ? 'inline-block' : 'none';
        if (currentSection === sections.length - 1) {
            submitBtn.disabled = !agreeCheckbox.checked;
        }
    }

    function validateForm() {
        const activeSection = sections[currentSection];
        const inputs = activeSection.querySelectorAll('input[required], select[required], textarea[required]');
        for (let input of inputs) {
            if (!input.value) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                input.focus();
                return false;
            }
        }
        return true;
    }

    // --- LÓGICA CONDICIONAL ---
    maritalStatusSelect.addEventListener('change', (e) => {
        const spouseDetails = document.getElementById('spouseDetails');
        const relationshipDates = document.getElementById('relationshipDates');
        const spouseLegend = document.getElementById('spouseLegend');
        const value = e.target.value;

        if (value === 'Casado(a)' || value === 'União Estável') {
            spouseLegend.textContent = 'Dados do Cônjuge / Companheiro(a)';
            spouseDetails.style.display = 'block';
            relationshipDates.style.display = 'block';
        } else if (value === 'Divorciado(a)' || value === 'Viúvo(a)') {
            spouseLegend.textContent = 'Dados do Ex-Cônjuge';
            spouseDetails.style.display = 'block';
            relationshipDates.style.display = 'block';
        } else {
            spouseDetails.style.display = 'none';
        }
    });

    document.querySelectorAll('input[type="radio"][name^="bg_q"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const detailsTextarea = e.target.closest('.form-group').querySelector('textarea');
            if (e.target.value === 'Sim') {
                detailsTextarea.style.display = 'block';
                detailsTextarea.required = true;
            } else {
                detailsTextarea.style.display = 'none';
                detailsTextarea.required = false;
                detailsTextarea.value = '';
            }
        });
    });
    
    agreeCheckbox.addEventListener('change', updateButtons);

    // --- GERAÇÃO DE PDF (CORRIGIDA E COMPLETA) ---
    async function generateAndSend() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ lineHeight: 1.5 });
        const formData = new FormData(document.getElementById('imm5257Form'));
        const data = Object.fromEntries(formData.entries());

        doc.setFontSize(18);
        doc.text("Respostas - Formulário IMM 5257", 14, 22);
        let y = 35;

        const addText = (label, value) => {
            if (value) {
                if (y > 270) { doc.addPage(); y = 20; }
                doc.setFontSize(12).setFont(undefined, 'bold');
                doc.text(label, 14, y);
                doc.setFontSize(11).setFont(undefined, 'normal');
                const textLines = doc.splitTextToSize(value, 180);
                doc.text(textLines, 14, y + 6);
                y += (textLines.length * 5) + 10;
            }
        };
        
        // Populando o PDF com TODOS os dados
        addText("Seção 1: Dados Pessoais", " ");
        addText("Nome Completo:", data.fullName);
        addText("Estado Civil:", data.maritalStatus);
        addText("Nome do Cônjuge/Ex-Cônjuge:", data.spouseFullName);
        addText("Data de Nasc. do Cônjuge/Ex-Cônjuge:", data.spouseDob);
        addText("Data de Início do Relacionamento:", data.marriageDate);
        addText("Data de Fim do Relacionamento:", data.separationDate);
        
        addText("Seção 2: Informações de Histórico", " ");
        addText("Teve Tuberculose?", `${data.bg_q1} ${data.bg_q1_details ? '- Detalhes: ' + data.bg_q1_details : ''}`);
        addText("Visto/Entrada Recusada?", `${data.bg_q2} ${data.bg_q2_details ? '- Detalhes: ' + data.bg_q2_details : ''}`);
        addText("Cometeu/Foi Preso por Crime?", `${data.bg_q3} ${data.bg_q3_details ? '- Detalhes: ' + data.bg_q3_details : ''}`);
        
        addText("Seção 3: Declaração", " ");
        addText("Local da Assinatura:", data.signature_location);
        addText("Data da Assinatura:", new Date().toLocaleDateString('pt-BR'));
        addText("Status do Termo:", "Concordou com os termos");

        const pdfName = `IMM5257_${data.fullName || 'Cliente'}.pdf`.replace(/[ ,]/g, '_');
        doc.save(pdfName);

        alert(`PDF "${pdfName}" gerado com sucesso! Ele foi baixado no seu dispositivo. Agora vamos abrir o WhatsApp para você enviá-lo.`);
        
        const clientName = data.fullName || "o cliente";
        const message = `Olá! Segue o formulário IMM 5257 preenchido por ${clientName}. O arquivo é "${pdfName}".`;
        
        // IMPORTANTE: Substitua 'SEUNUMERO' pelo seu número
        const whatsappNumber = "5561999991865"; 
        const whatsappUrl = `https://api.whatsapp.com/send?phone=${whatsappNumber}&text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    }

    // Inicia o formulário
    showSection(currentSection);
</script>

</body>
</html>
