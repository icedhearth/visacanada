<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário IMM 5257 (PDF Corrigido) | Visto Canadense</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 15px; color: #333; }
        .container { max-width: 850px; margin: 20px auto; background-color: #ffffff; padding: 30px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #1d3557; margin-bottom: 25px; }
        .form-section { display: none; }
        .form-section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bar { width: 100%; background-color: #e9ecef; border-radius: 5px; margin-bottom: 30px; overflow: hidden; }
        .progress-bar-fill { height: 12px; width: 0%; background-color: #e63946; border-radius: 5px; transition: width 0.4s ease-in-out; }
        .form-group { margin-bottom: 22px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        input[type="text"], input[type="date"], input[type="email"], input[type="tel"], select, textarea { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 5px; box-sizing: border-box; font-size: 16px; transition: border-color 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: #e63946; outline: none; box-shadow: 0 0 5px rgba(230, 57, 70, 0.2); }
        fieldset { border: 1px solid #dee2e6; border-radius: 5px; padding: 20px; margin-bottom: 20px; }
        legend { font-weight: 700; color: #1d3557; padding: 0 10px; }
        .radio-group label { display: inline-block; margin-right: 25px; font-weight: normal; }
        .hidden-field { display: none; margin-top: 15px; border-left: 3px solid #e63946; padding-left: 15px; animation: fadeIn 0.5s; }
        .navigation-buttons { display: flex; justify-content: space-between; margin-top: 30px; }
        button { padding: 12px 28px; border: none; border-radius: 5px; background-color: #e63946; color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        button:hover:not(:disabled) { background-color: #d62828; transform: translateY(-2px); }
        button:disabled { background-color: #adb5bd; cursor: not-allowed; }
        button#prevBtn { background-color: #6c757d; }
        button#prevBtn:hover { background-color: #5a6268; }
        .declaration-box { border: 1px solid #ddd; padding: 15px; margin-top: 20px; background-color: #fafafa; font-size: 14px; max-height: 250px; overflow-y: auto; }
        .agreement-group { margin-top: 20px; display: flex; align-items: center; }
        .agreement-group input[type="checkbox"] { width: auto; margin-right: 10px; transform: scale(1.2); }
        #statusMessage { text-align: center; margin-top: 20px; font-weight: bold; color: #1d3557; min-height: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Formulário de Visto Canadense (IMM 5257)</h1>
    <div class="progress-bar"><div class="progress-bar-fill" id="progressBar"></div></div>
    <form id="imm5257Form">
        <div class="form-section active">
            <h2>Dados Pessoais</h2>
            <div class="form-group"><label for="uci">UCI (Unique Client Identifier), se souber</label><input type="text" id="uci" name="uci"></div>
            <div class="form-group"><label for="fullName">Nome Completo (igual ao passaporte)</label><input type="text" id="fullName" name="fullName" required></div>
            <div class="form-group"><label>Já usou outro nome?</label><div class="radio-group"><label><input type="radio" name="usedOtherName" value="Sim"> Sim</label><label><input type="radio" name="usedOtherName" value="Não" checked> Não</label></div>
                <div id="otherNameField" class="hidden-field"><label for="otherName">Nome Adicional</label><input type="text" id="otherName" name="otherName"></div>
            </div>
            <div class="form-group"><label for="sex">Sexo</label><select id="sex" name="sex"><option>Feminino</option><option>Masculino</option><option>Outro</option></select></div>
            <div class="form-group"><label for="dob">Data de Nascimento</label><input type="date" id="dob" name="dob" required></div>
            <div class="form-group"><label for="cityOfBirth">Cidade/Vila de Nascimento</label><input type="text" id="cityOfBirth" name="cityOfBirth" required></div>
            <div class="form-group"><label for="countryOfBirth">País de Nascimento</label><input type="text" id="countryOfBirth" name="countryOfBirth" required></div>
            <div class="form-group"><label for="citizenship">Cidadania</label><input type="text" id="citizenship" name="citizenship" required></div>
        </div>
        <div class="form-section">
            <h2>Residência</h2>
            <fieldset><legend>Residência Atual</legend>
                <div class="form-group"><label for="currentResidenceCountry">País/Território</label><input type="text" id="currentResidenceCountry" name="currentResidenceCountry" required></div>
                <div class="form-group"><label for="currentResidenceStatus">Status</label><select id="currentResidenceStatus" name="currentResidenceStatus"><option>Cidadão</option><option>Residente Permanente</option><option>Trabalhador</option><option>Estudante</option><option>Visitante</option><option>Outro</option></select></div>
            </fieldset>
            <div class="form-group"><label>Viveu em outro país por mais de 6 meses nos últimos 5 anos?</label><div class="radio-group"><label><input type="radio" name="livedOtherCountry" value="Sim"> Sim</label><label><input type="radio" name="livedOtherCountry" value="Não" checked> Não</label></div>
                <div id="previousResidenceField" class="hidden-field"><label for="previousResidenceDetails">Detalhes dos países anteriores</label><textarea name="previousResidenceDetails" placeholder="Liste cada país, status e período."></textarea></div>
            </div>
        </div>
        <div class="form-section">
            <h2>Estado Civil</h2>
            <div class="form-group"><label for="maritalStatus">Estado Civil Atual</label>
                <select id="maritalStatus" name="maritalStatus">
                    <option value="Solteiro(a)">Solteiro(a)</option><option value="Casado(a)">Casado(a)</option><option value="União Estável">União Estável</option><option value="Divorciado(a)">Divorciado(a)</option><option value="Viúvo(a)">Viúvo(a)</option>
                </select>
            </div>
            <div id="spouseDetails" class="hidden-field"><fieldset><legend id="spouseLegend">Dados do Cônjuge</legend>
                    <div class="form-group"><label for="spouseFullName">Nome Completo</label><input type="text" id="spouseFullName" name="spouseFullName"></div>
                    <div id="relationshipDates"><div class="form-group"><label for="marriageDate">Data de Início do Casamento/União</label><input type="date" id="marriageDate" name="marriageDate"></div></div>
            </fieldset></div>
        </div>
        <div class="form-section">
            <h2>Passaporte e Documentos</h2>
            <fieldset><legend>Passaporte</legend>
                <div class="form-group"><label for="passportNumber">Número do Passaporte</label><input type="text" id="passportNumber" name="passportNumber" required></div>
                <div class="form-group"><label for="passportCountry">País de Emissão</label><input type="text" id="passportCountry" name="passportCountry" required></div>
                <div class="form-group"><label for="passportIssueDate">Data de Emissão</label><input type="date" id="passportIssueDate" name="passportIssueDate" required></div>
                <div class="form-group"><label for="passportExpiryDate">Data de Validade</label><input type="date" id="passportExpiryDate" name="passportExpiryDate" required></div>
            </fieldset>
            <div class="form-group"><label>Possui Documento de Identidade Nacional?</label><div class="radio-group"><label><input type="radio" name="hasNationalId" value="Sim"> Sim</label><label><input type="radio" name="hasNationalId" value="Não" checked> Não</label></div>
                <div id="nationalIdField" class="hidden-field"><label for="nationalIdNumber">Número do Documento</label><input type="text" id="nationalIdNumber" name="nationalIdNumber"></div>
            </div>
            <div class="form-group"><label>É residente permanente legal dos EUA (possui Green Card)?</label><div class="radio-group"><label><input type="radio" name="hasGreenCard" value="Sim"> Sim</label><label><input type="radio" name="hasGreenCard" value="Não" checked> Não</label></div>
                <div id="greenCardField" class="hidden-field"><label for="greenCardNumber">Número do Green Card</label><input type="text" id="greenCardNumber" name="greenCardNumber"></div>
            </div>
        </div>
        <div class="form-section">
             <h2>Informações de Contato</h2>
            <div class="form-group"><label for="mailingAddress">Endereço de Correspondência</label><textarea id="mailingAddress" name="mailingAddress" required placeholder="Endereço completo com rua, número, bairro, CEP, cidade e país."></textarea></div>
            <div class="form-group"><label for="phone">Telefone Celular</label><input type="tel" id="phone" name="phone" required></div>
            <div class="form-group"><label for="email">E-mail</label><input type="email" id="email" name="email" required></div>
        </div>
        <div class="form-section">
            <h2>Detalhes da Visita ao Canadá</h2>
            <div class="form-group"><label for="purpose">Propósito da Visita</label><select id="purpose" name="purpose"><option>Turismo</option><option>Negócios</option><option>Visitar Família/Amigos</option></select></div>
            <div class="form-group"><label for="stay_from">Data de Chegada</label><input type="date" id="stay_from" name="stay_from" required></div>
            <div class="form-group"><label for="stay_to">Data de Saída</label><input type="date" id="stay_to" name="stay_to" required></div>
            <div class="form-group"><label for="funds">Fundos disponíveis para a estadia (CAD)</label><input type="text" id="funds" name="funds" placeholder="Ex: 5000" required></div>
            <div class="form-group"><label for="visit_person_details">Pessoas ou instituições que irá visitar (Nome, endereço, relação)</label><textarea id="visit_person_details" name="visit_person_details"></textarea></div>
        </div>
        <div class="form-section">
            <h2>Educação e Emprego</h2>
            <div class="form-group"><label>Possui ensino superior ou técnico?</label><div class="radio-group"><label><input type="radio" name="hasEducation" value="Sim"> Sim</label><label><input type="radio" name="hasEducation" value="Não" checked> Não</label></div>
                <div id="educationField" class="hidden-field"><label for="educationDetails">Detalhes da Educação</label><textarea name="educationDetails" placeholder="Liste curso, escola, cidade, período."></textarea></div>
            </div>
            <div class="form-group"><label for="employmentDetails">Histórico de Emprego (últimos 10 anos)</label><textarea id="employmentDetails" name="employmentDetails" placeholder="Liste cada emprego (período, cargo, empregador, cidade), começando pelo mais recente." required></textarea></div>
        </div>
        <div class="form-section">
            <h2>Informações de Histórico (Background)</h2>
            <p>Responda "Sim" ou "Não". Se responder "Sim", forneça detalhes.</p>
            <div class="form-group"><label>1. Você ou um familiar teve tuberculose nos últimos 2 anos?</label><div class="radio-group"><label><input type="radio" name="bg_q1" value="Sim"> Sim</label><label><input type="radio" name="bg_q1" value="Não" checked> Não</label></div>
                <textarea name="bg_q1_details" class="hidden-field" placeholder="Forneça detalhes."></textarea>
            </div>
             <div class="form-group"><label>2. Já permaneceu no Canadá além da validade do seu status, ou trabalhou/estudou sem permissão?</label><div class="radio-group"><label><input type="radio" name="bg_q2" value="Sim"> Sim</label><label><input type="radio" name="bg_q2" value="Não" checked> Não</label></div>
                <textarea name="bg_q2_details" class="hidden-field" placeholder="Forneça detalhes."></textarea>
            </div>
            <div class="form-group"><label>3. Já teve um visto ou entrada recusada para o Canadá ou qualquer outro país?</label><div class="radio-group"><label><input type="radio" name="bg_q3" value="Sim"> Sim</label><label><input type="radio" name="bg_q3" value="Não" checked> Não</label></div>
                <textarea name="bg_q3_details" class="hidden-field" placeholder="Qual país, quando e o motivo."></textarea>
            </div>
            <div class="form-group"><label>4. Já cometeu, foi preso(a), acusado(a) ou condenado(a) por crime em qualquer país?</label><div class="radio-group"><label><input type="radio" name="bg_q4" value="Sim"> Sim</label><label><input type="radio" name="bg_q4" value="Não" checked> Não</label></div>
                <textarea name="bg_q4_details" class="hidden-field" placeholder="Forneça detalhes completos."></textarea>
            </div>
            <div class="form-group"><label>5. Serviu em alguma organização militar, milícia, polícia ou grupo de defesa civil?</label><div class="radio-group"><label><input type="radio" name="bg_q5" value="Sim"> Sim</label><label><input type="radio" name="bg_q5" value="Não" checked> Não</label></div>
                <textarea name="bg_q5_details" class="hidden-field" placeholder="Quais datas, país e detalhes da sua função."></textarea>
            </div>
        </div>
        <div class="form-section">
            <h2>Declaração e Autorização</h2>
            <div class="declaration-box">
                <h4>Declaração</h4>
                <p>Eu, <strong id="declarantName"></strong>, declaro, sob as penas da lei, que li e compreendi integralmente todas as questões contidas nesta solicitação de visto (Formulário IMM 5257) e afirmo que as respostas por mim fornecidas são verdadeiras, completas e corretas, conforme o meu melhor conhecimento e convicção.</p>
                <p>Declaro estar ciente de que: <ul><li>Qualquer declaração falsa, incompleta ou enganosa poderá resultar na recusa permanente do visto ou na negativa de admissão no Canadá.</li><li>As informações contidas nesta solicitação poderão ser compartilhadas com outras agências governamentais do Canadá para fins de aplicação da lei ou para propósitos imigratórios.</li></ul></p>
                <p>Declaro ainda: <ul><li>Que sou exclusivamente responsável pela autenticidade e exatidão dos documentos apresentados e das informações prestadas.</li><li>Que tenho pleno conhecimento de que a concessão ou negativa do visto é prerrogativa exclusiva das Autoridades de Imigração Canadenses (IRCC).</li><li>Que reconheço que o serviço contratado constitui assessoria, não abrangendo serviços de entrega ou retirada de documentos no Centro de Solicitação de Visto (VAC).</li></ul></p>
                 <h4>Autorização</h4>
                 <p>Declaro, por fim, ter revisado e conferido todos os dados por mim apresentados, autorizando expressamente a empresa <strong>Objetivo Turismo Ltda.</strong>, a proceder com o envio eletrônico do Formulário IMM 5257 às autoridades canadenses, bem como a realizar o pagamento das taxas e os agendamentos necessários.</p>
            </div>
            <div class="form-group"><label for="signature_location">Local</label><input type="text" id="signature_location" name="signature_location" required></div>
            <div class="agreement-group"><input type="checkbox" id="agreeTerms"><label for="agreeTerms">Li e concordo com os termos desta declaração.</label></div>
        </div>
        <div class="navigation-buttons">
            <button type="button" id="prevBtn" onclick="navigate(-1)">Anterior</button>
            <button type="button" id="nextBtn" onclick="navigate(1)">Próximo</button>
            <button type="button" id="submitBtn" onclick="generateAndSend()">Gerar PDF e Enviar para Análise</button>
        </div>
        <div id="statusMessage"></div>
    </form>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-storage.js";

    // A configuração do Firebase e a lógica de envio (generateAndSend) permanecem as mesmas.
    const firebaseConfig = {
        apiKey: "AIzaSyAkBV0rHEghBOHl2mDOs6rMDHkUgYMxFr0",
        authDomain: "visaformulariostorage.firebaseapp.com",
        projectId: "visaformulariostorage",
        storageBucket: "visaformulariostorage.firebasestorage.app",
        messagingSenderId: "720170394408",
        appId: "1:720170394408:web:b1c294c39c489388f6261d",
        measurementId: "G-ZFCV4JEEFT"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const { jsPDF } = window.jspdf;

    let currentSection = 0;
    const sections = document.querySelectorAll('.form-section');
    const progressBar = document.getElementById('progressBar');
    const submitBtn = document.getElementById('submitBtn');
    const agreeCheckbox = document.getElementById('agreeTerms');
    const statusMessage = document.getElementById('statusMessage');
    
    window.navigate = function(step) {
        if (step === 1 && !validateForm()) return;
        currentSection = Math.max(0, Math.min(sections.length - 1, currentSection + step));
        showSection(currentSection);
    }

    window.generateAndSend = async function() {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processando...';
        statusMessage.textContent = 'Iniciando processo...';
        
        const whatsappWindow = window.open('', '_blank');
        whatsappWindow.document.write('Processando seu formulário... Por favor, aguarde um momento.');
        
        try {
            const data = Object.fromEntries(new FormData(document.getElementById('imm5257Form')).entries());
            const doc = new jsPDF({ lineHeight: 1.5 });
            
            statusMessage.textContent = 'Gerando PDF...';
            populatePdf(doc, data);

            const solicitanteNome = data.fullName || 'Nao_Informado';
            const timestamp = Date.now();
            const pdfName = `IMM5257_${solicitanteNome.replace(/\s+/g, '_')}_${timestamp}.pdf`;
            
            doc.save(pdfName);
            const pdfBlob = doc.output('blob');
            const firebaseFileName = `pdfs/IMM5257_${solicitanteNome.replace(/\s+/g, '_')}_${timestamp}.pdf`;

            statusMessage.textContent = 'Enviando para o servidor seguro...';
            const storageRef = ref(storage, firebaseFileName);
            await uploadBytes(storageRef, pdfBlob);

            statusMessage.textContent = 'Obtendo link de compartilhamento...';
            const downloadUrl = await getDownloadURL(storageRef);
            
            statusMessage.textContent = 'Sucesso! Redirecionando para o WhatsApp...';
            const whatsappMessage = `Análise de Visto Canadense para ${solicitanteNome} está pronta.\n\nAcesse o formulário seguro no link: ${downloadUrl}`;
            
            const fixedWhatsAppNumber = '5561999998165';
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${fixedWhatsAppNumber}&text=${encodeURIComponent(whatsappMessage)}`;
            
            whatsappWindow.location.href = whatsappUrl;

        } catch (error) {
            console.error("Erro no processo de envio:", error);
            statusMessage.textContent = `Erro: ${error.message}`;
            if (whatsappWindow) whatsappWindow.close();
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Gerar PDF e Enviar para Análise';
        }
    }
    
    // =======================================================
    // NOVA FUNÇÃO DE PDF COM QUEBRA DE PÁGINA INTELIGENTE
    // =======================================================
    function populatePdf(doc, data) {
        let y = 20; // Posição vertical inicial
        const pageHeight = doc.internal.pageSize.height;
        const topMargin = 20;
        const bottomMargin = 20;
        const leftMargin = 14;
        const indent = 18;
        const usableWidth = doc.internal.pageSize.width - leftMargin - indent;

        const checkPageBreak = (neededHeight) => {
            if (y + neededHeight > pageHeight - bottomMargin) {
                doc.addPage();
                y = topMargin;
            }
        };

        const addTitle = (title) => {
            checkPageBreak(12);
            doc.setFontSize(14).setFont(undefined, 'bold');
            doc.text(title, leftMargin, y);
            y += 12;
        };

        const addField = (label, value) => {
            if (value && value.trim() !== '') {
                // Estima a altura do label e do valor
                const labelLines = doc.splitTextToSize(label, usableWidth);
                const valueLines = doc.splitTextToSize(value, usableWidth);
                const neededHeight = (labelLines.length * 5) + (valueLines.length * 5) + 6;
                checkPageBreak(neededHeight);

                // Escreve o label
                doc.setFontSize(11).setFont(undefined, 'bold');
                doc.text(label, leftMargin, y);
                y += 6;

                // Escreve o valor
                doc.setFontSize(10).setFont(undefined, 'normal');
                doc.text(valueLines, indent, y);
                y += (valueLines.length * 5) + 5;
            }
        };
        
        // --- Início da Geração do Conteúdo do PDF ---
        addTitle("Respostas - Formulário IMM 5257");
        addTitle("Dados Pessoais");
        addField("Nome Completo:", data.fullName); addField("UCI:", data.uci); addField("Outro Nome Usado:", data.otherName); addField("Sexo:", data.sex); addField("Data de Nasc.:", data.dob); addField("Cidade de Nasc.:", data.cityOfBirth); addField("País de Nasc.:", data.countryOfBirth); addField("Cidadania:", data.citizenship);
        
        addTitle("Residência e Estado Civil");
        addField("País de Residência:", data.currentResidenceCountry); addField("Status:", data.currentResidenceStatus); addField("Resid. Anteriores:", data.previousResidenceDetails); addField("Estado Civil:", data.maritalStatus); addField("Nome Cônjuge:", data.spouseFullName); addField("Data Casamento/União:", data.marriageDate);

        addTitle("Passaporte e Documentos");
        addField("No. Passaporte:", data.passportNumber); addField("País Emissão:", data.passportCountry); addField("Datas (Emissão/Val.):", `${data.passportIssueDate || ''} / ${data.passportExpiryDate || ''}`); addField("ID Nacional:", data.nationalIdNumber); addField("Possui Green Card?:", `${data.hasGreenCard || 'Não'} - ${data.greenCardNumber || ''}`);
        
        addTitle("Contato e Visita");
        addField("E-mail:", data.email); addField("Telefone:", data.phone); addField("Endereço:", data.mailingAddress); addField("Propósito da Visita:", data.purpose); addField("Período:", `${data.stay_from || ''} a ${data.stay_to || ''}`); addField("Fundos (CAD):", data.funds); addField("Pessoas/Locais a Visitar:", data.visit_person_details);
        
        addTitle("Educação e Emprego");
        addField("Educação:", data.educationDetails); addField("Emprego (10 anos):", data.employmentDetails);
        
        addTitle("Histórico");
        addField("Tuberculose:", `${data.bg_q1} ${data.bg_q1_details ? '- Detalhes: ' + data.bg_q1_details : ''}`); addField("Violou leis de imigração?:", `${data.bg_q2} ${data.bg_q2_details ? '- Detalhes: ' + data.bg_q2_details : ''}`); addField("Visto Recusado?:", `${data.bg_q3} ${data.bg_q3_details ? '- Detalhes: ' + data.bg_q3_details : ''}`); addField("Crimes?:", `${data.bg_q4} ${data.bg_q4_details ? '- Detalhes: ' + data.bg_q4_details : ''}`); addField("Serviço Militar/Policial?:", `${data.bg_q5} ${data.bg_q5_details ? '- Detalhes: ' + data.bg_q5_details : ''}`);
        
        addTitle("Declaração");
        addField("Local:", data.signature_location); addField("Data:", new Date().toLocaleDateString('pt-BR')); addField("Termos:", data.agreeTerms ? "Concordou com os termos" : "Não concordou");
    }
    
    // Funções de Navegação e Lógica Condicional (sem alterações)
    function showSection(sectionIndex) { 
        if (sectionIndex === sections.length - 1) { document.getElementById('declarantName').textContent = document.getElementById('fullName').value || "[Nome não informado]"; }
        sections.forEach((section, index) => section.classList.toggle('active', index === sectionIndex));
        updateProgressBar();
        updateButtons();
    }
    function validateForm() { const activeSection = sections[currentSection]; for (const input of activeSection.querySelectorAll('[required]')) { if (!input.value) { alert('Por favor, preencha todos os campos obrigatórios.'); input.focus(); return false; } } return true; }
    function updateProgressBar() { progressBar.style.width = ((currentSection) / (sections.length - 1)) * 100 + '%'; }
    function updateButtons() { document.getElementById('prevBtn').style.display = currentSection === 0 ? 'none' : 'inline-block'; document.getElementById('nextBtn').style.display = currentSection === sections.length - 1 ? 'none' : 'inline-block'; submitBtn.style.display = currentSection === sections.length - 1 ? 'inline-block' : 'none'; if (currentSection === sections.length - 1) { submitBtn.disabled = !agreeCheckbox.checked; } }
    function setupConditionalLogic(radioGroupName, fieldId) { document.querySelectorAll(`input[type="radio"][name="${radioGroupName}"]`).forEach(radio => { radio.addEventListener('change', e => { const field = document.getElementById(fieldId); const isYes = e.target.value === 'Sim'; field.style.display = isYes ? 'block' : 'none'; field.querySelectorAll('input, textarea').forEach(input => input.required = isYes); }); }); }
    setupConditionalLogic('usedOtherName', 'otherNameField');
    setupConditionalLogic('livedOtherCountry', 'previousResidenceField');
    setupConditionalLogic('hasNationalId', 'nationalIdField');
    setupConditionalLogic('hasGreenCard', 'greenCardField');
    setupConditionalLogic('hasEducation', 'educationField');
    setupConditionalLogic('bg_q1', 'bg_q1_details'); setupConditionalLogic('bg_q2', 'bg_q2_details'); setupConditionalLogic('bg_q3', 'bg_q3_details'); setupConditionalLogic('bg_q4', 'bg_q4_details'); setupConditionalLogic('bg_q5', 'bg_q5_details');
    document.getElementById('maritalStatus').addEventListener('change', e => { const value = e.target.value; const field = document.getElementById('spouseDetails'); const isNeeded = ['Casado(a)', 'União Estável', 'Divorciado(a)', 'Viúvo(a)'].includes(value); field.style.display = isNeeded ? 'block' : 'none'; field.querySelectorAll('input').forEach(input => input.required = isNeeded); });
    agreeCheckbox.addEventListener('change', updateButtons);
    showSection(currentSection);

</script>

</body>
</html>
