<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário IMM 5257 (Firebase) | Visto Canadense</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* O mesmo CSS da versão anterior, sem alterações */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 15px; color: #333; }
        .container { max-width: 850px; margin: 20px auto; background-color: #ffffff; padding: 30px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #1d3557; margin-bottom: 25px; }
        .form-section { display: none; }
        .form-section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bar { width: 100%; background-color: #e9ecef; border-radius: 5px; margin-bottom: 30px; overflow: hidden; }
        .progress-bar-fill { height: 12px; width: 0%; background-color: #e63946; border-radius: 5px; transition: width 0.4s ease-in-out; }
        .form-group { margin-bottom: 22px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        input[type="text"], input[type="date"], input[type="email"], input[type="tel"], select, textarea { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 5px; box-sizing: border-box; font-size: 16px; transition: border-color 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: #e63946; outline: none; box-shadow: 0 0 5px rgba(230, 57, 70, 0.2); }
        fieldset { border: 1px solid #dee2e6; border-radius: 5px; padding: 20px; margin-bottom: 20px; }
        legend { font-weight: 700; color: #1d3557; padding: 0 10px; }
        .radio-group label { display: inline-block; margin-right: 25px; font-weight: normal; }
        .hidden-field { display: none; margin-top: 15px; border-left: 3px solid #e63946; padding-left: 15px; animation: fadeIn 0.5s; }
        .navigation-buttons { display: flex; justify-content: space-between; margin-top: 30px; }
        button { padding: 12px 28px; border: none; border-radius: 5px; background-color: #e63946; color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        button:hover:not(:disabled) { background-color: #d62828; transform: translateY(-2px); }
        button:disabled { background-color: #adb5bd; cursor: not-allowed; }
        button#prevBtn { background-color: #6c757d; }
        button#prevBtn:hover { background-color: #5a6268; }
        .declaration-box { border: 1px solid #ddd; padding: 15px; margin-top: 20px; background-color: #fafafa; font-size: 14px; max-height: 250px; overflow-y: auto; }
        .agreement-group { margin-top: 20px; display: flex; align-items: center; }
        .agreement-group input[type="checkbox"] { width: auto; margin-right: 10px; transform: scale(1.2); }
    </style>
</head>
<body>

<div class="container">
    <h1>Formulário de Visto Canadense (IMM 5257)</h1>
    <div class="progress-bar"><div class="progress-bar-fill" id="progressBar"></div></div>
    <form id="imm5257Form">
        <div class="form-section active">
            <h2>Dados Pessoais</h2>
            <div class="form-group"><label for="fullName">Nome Completo (igual ao passaporte)</label><input type="text" id="fullName" name="fullName" required></div>
            <div class="form-group"><label>Já usou outro nome (apelido, nome de solteira, etc.)?</label>
                <div class="radio-group"><label><input type="radio" name="usedOtherName" value="Sim"> Sim</label><label><input type="radio" name="usedOtherName" value="Não" checked> Não</label></div>
                <div id="otherNameField" class="hidden-field"><label for="otherName">Nome Adicional</label><input type="text" id="otherName" name="otherName"></div>
            </div>
            <div class="form-group"><label for="sex">Sexo</label><select id="sex" name="sex"><option value="Feminino">Feminino</option><option value="Masculino">Masculino</option><option value="Outro">Outro</option></select></div>
            <div class="form-group"><label for="dob">Data de Nascimento</label><input type="date" id="dob" name="dob" required></div>
            <div class="form-group"><label for="pob">Local de Nascimento (Cidade e País)</label><input type="text" id="pob" name="pob" required></div>
            <div class="form-group"><label for="citizenship">Cidadania</label><input type="text" id="citizenship" name="citizenship" required></div>
        </div>

        <div class="form-section">
            <h2>Residência</h2>
            <fieldset><legend>Residência Atual</legend>
                <div class="form-group"><label for="currentResidenceCountry">País/Território</label><input type="text" id="currentResidenceCountry" name="currentResidenceCountry" required></div>
                <div class="form-group"><label for="currentResidenceStatus">Status</label><select id="currentResidenceStatus" name="currentResidenceStatus"><option>Cidadão</option><option>Residente Permanente</option><option>Trabalhador</option><option>Estudante</option><option>Visitante</option><option>Outro</option></select></div>
            </fieldset>
            <div class="form-group"><label>Viveu em outro país por mais de 6 meses nos últimos 5 anos?</label>
                <div class="radio-group"><label><input type="radio" name="livedOtherCountry" value="Sim"> Sim</label><label><input type="radio" name="livedOtherCountry" value="Não" checked> Não</label></div>
                <div id="previousResidenceField" class="hidden-field"><label for="previousResidenceDetails">Detalhes dos países anteriores</label><textarea name="previousResidenceDetails" placeholder="Liste cada país, status e período."></textarea></div>
            </div>
        </div>

        <div class="form-section">
            <h2>Declaração e Assinatura</h2>
            <div class="declaration-box">
                <h4>Declaração e Autorização</h4>
                <p>Eu, <strong id="declarantName"></strong>, declaro que li e compreendi as questões e que minhas respostas são verdadeiras e completas. Estou ciente de que fornecer informações falsas é uma ofensa grave sob a lei de imigração do Canadá.</p>
                <p>Autorizo a empresa <strong>Objetivo Turismo Ltda.</strong> a proceder com o envio do Formulário IMM 5257 e realizar pagamentos e agendamentos em meu nome.</p>
            </div>
            <div class="form-group"><label for="signature_location">Local</label><input type="text" id="signature_location" name="signature_location" required></div>
            <div class="agreement-group"><input type="checkbox" id="agreeTerms"><label for="agreeTerms">Li e concordo com os termos.</label></div>
        </div>

        <div class="navigation-buttons">
            <button type="button" id="prevBtn" onclick="navigate(-1)">Anterior</button>
            <button type="button" id="nextBtn" onclick="navigate(1)">Próximo</button>
            <button type="button" id="submitBtn" onclick="generateAndSend()">Gerar PDF e Enviar para Análise</button>
        </div>
    </form>
</div>


<script type="module">
    // --- INÍCIO DA SEÇÃO DE SCRIPTS ATUALIZADA ---

    // 1. Importações do Firebase SDK (como no seu arquivo)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-storage.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-analytics.js";

    // 2. Suas credenciais do Firebase (extraídas do arquivo que você forneceu)
    const firebaseConfig = {
        apiKey: "AIzaSyAkBV0rHEghBOHl2mDOs6rMDHkUgYMxFr0",
        authDomain: "visaformulariostorage.firebaseapp.com",
        projectId: "visaformulariostorage",
        storageBucket: "visaformulariostorage.appspot.com",
        messagingSenderId: "720170394408",
        appId: "1:720170394408:web:b1c294c39c489388f6261d",
        measurementId: "G-ZFCV4JEEFT"
    };

    // 3. Inicialização do Firebase
    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const analytics = getAnalytics(app);
    const { jsPDF } = window.jspdf;

    // A lógica de navegação e campos condicionais permanece a mesma da versão anterior
    let currentSection = 0;
    const sections = document.querySelectorAll('.form-section');
    const progressBar = document.getElementById('progressBar');
    const submitBtn = document.getElementById('submitBtn');
    const agreeCheckbox = document.getElementById('agreeTerms');
    
    // Anexando as funções ao objeto window para que o onclick as encontre no escopo do módulo
    window.navigate = function(step) {
        if (step === 1 && !validateForm()) return;
        currentSection = Math.max(0, Math.min(sections.length - 1, currentSection + step));
        showSection(currentSection);
    }

    window.generateAndSend = async function() {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processando...';
        
        try {
            // 1. Gerar o PDF em memória como um 'blob'
            alert('Gerando o PDF...');
            const doc = new jsPDF({ lineHeight: 1.5 });
            const data = Object.fromEntries(new FormData(document.getElementById('imm5257Form')).entries());
            
            // Lógica para popular o PDF (idêntica à versão anterior)
            let y = 22;
            const addTitle = (title) => { if (y > 260) { doc.addPage(); y = 20; } doc.setFontSize(14).setFont(undefined, 'bold'); doc.text(title, 14, y); y += 10; };
            const addField = (label, value) => {
                if (value && value.trim() !== '') {
                    if (y > 270) { doc.addPage(); y = 20; }
                    doc.setFontSize(10).setFont(undefined, 'bold'); doc.text(label, 14, y);
                    doc.setFontSize(10).setFont(undefined, 'normal');
                    const textLines = doc.splitTextToSize(value, 170); doc.text(textLines, 50, y);
                    y += (textLines.length * 5) + 4;
                }
            };
            addTitle("Respostas - IMM 5257");
            addTitle("Dados Pessoais");
            addField("Nome Completo:", data.fullName);
            // ... Adicione todos os outros campos aqui para o PDF ficar completo ...
            addTitle("Declaração");
            addField("Local:", data.signature_location);
            addField("Data:", new Date().toLocaleDateString('pt-BR'));
            addField("Termos:", "Concordou com os termos");

            const pdfBlob = doc.output('blob');
            const solicitanteNome = data.fullName || 'Nao_Informado';
            const timestamp = Date.now();
            const firebaseFileName = `formularios_canada/IMM5257_${solicitanteNome.replace(/\s+/g, '_')}_${timestamp}.pdf`;

            // 2. Fazer o Upload para o Firebase Storage
            alert('Enviando para o servidor seguro...');
            const storageRef = ref(storage, firebaseFileName);
            await uploadBytes(storageRef, pdfBlob);

            // 3. Obter a URL de Download
            const downloadUrl = await getDownloadURL(storageRef);
            
            // 4. Montar e abrir o link do WhatsApp
            alert('Sucesso! Preparando para enviar via WhatsApp.');
            const whatsappMessage = `Análise de Visto Canadense para ${solicitanteNome} está pronta.\n\nAcesse o formulário seguro no link: ${downloadUrl}`;
            
            // Use o mesmo número do seu outro formulário
            const fixedWhatsAppNumber = '5561999998165';
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${fixedWhatsAppNumber}&text=${encodeURIComponent(whatsappMessage)}`;
            
            window.open(whatsappUrl, '_blank');

        } catch (error) {
            console.error("Erro no processo de envio:", error);
            alert("Ocorreu um erro ao enviar o formulário. Verifique o console para mais detalhes.");
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Gerar PDF e Enviar para Análise';
        }
    }
    
    // Funções auxiliares que precisam estar no escopo global para o onclick
    function showSection(sectionIndex) {
        if (sectionIndex === sections.length - 1) { document.getElementById('declarantName').textContent = document.getElementById('fullName').value || "[Nome não informado]"; }
        sections.forEach((section, index) => section.classList.toggle('active', index === sectionIndex));
        updateProgressBar();
        updateButtons();
    }
    
    function validateForm() {
        const activeSection = sections[currentSection];
        for (const input of activeSection.querySelectorAll('[required]')) {
            if (!input.value) { alert('Por favor, preencha todos os campos obrigatórios.'); input.focus(); return false; }
        }
        return true;
    }
    
    function updateProgressBar() { progressBar.style.width = ((currentSection) / (sections.length - 1)) * 100 + '%'; }
    
    function updateButtons() {
        document.getElementById('prevBtn').style.display = currentSection === 0 ? 'none' : 'inline-block';
        document.getElementById('nextBtn').style.display = currentSection === sections.length - 1 ? 'none' : 'inline-block';
        submitBtn.style.display = currentSection === sections.length - 1 ? 'inline-block' : 'none';
        if (currentSection === sections.length - 1) { submitBtn.disabled = !agreeCheckbox.checked; }
    }
    
    // Lógica condicional (precisa ser exposta ou chamada internamente)
    function setupConditionalLogic(radioGroupName, fieldId) {
        document.querySelectorAll(`input[type="radio"][name="${radioGroupName}"]`).forEach(radio => {
            radio.addEventListener('change', e => {
                const field = document.getElementById(fieldId);
                const isYes = e.target.value === 'Sim';
                field.style.display = isYes ? 'block' : 'none';
                field.querySelectorAll('input, textarea').forEach(input => input.required = isYes);
            });
        });
    }

    // Inicia a lógica condicional e o formulário
    setupConditionalLogic('usedOtherName', 'otherNameField');
    setupConditionalLogic('livedOtherCountry', 'previousResidenceField');
    setupConditionalLogic('hasNationalId', 'nationalIdField');
    setupConditionalLogic('hasEducation', 'educationField');
    setupConditionalLogic('bg_q1', 'bg_q1_details'); setupConditionalLogic('bg_q2', 'bg_q2_details'); setupConditionalLogic('bg_q3', 'bg_q3_details'); setupConditionalLogic('bg_q4', 'bg_q4_details');
    document.getElementById('maritalStatus').addEventListener('change', e => {
        const value = e.target.value; const field = document.getElementById('spouseDetails');
        const isNeeded = ['Casado(a)', 'União Estável', 'Divorciado(a)', 'Viúvo(a)'].includes(value);
        field.style.display = isNeeded ? 'block' : 'none';
        field.querySelectorAll('input').forEach(input => input.required = isNeeded);
    });
    agreeCheckbox.addEventListener('change', updateButtons);
    
    // Inicia o formulário na primeira seção
    showSection(currentSection);

</script>

</body>
</html>
